name: åŒæ­¥æ–‡ä»¶åˆ°å¤šä¸ªä»“åº“ (æ›¿ä»£æ–¹æ¡ˆ)

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'shared/**'
  workflow_dispatch:

jobs:
  sync-to-repos:
    name: åŒæ­¥æ–‡ä»¶åˆ°æŒ‡å®šä»“åº“
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # åœ¨è¿™é‡Œæ˜ç¡®åˆ—å‡ºè¦åŒæ­¥çš„ç›®æ ‡ä»“åº“
        repo:
          - 'Hub-yang/50projects-vue3'
      fail-fast: false  # å³ä½¿æŸä¸ªä»“åº“å¤±è´¥,ç»§ç»­åŒæ­¥å…¶ä»–ä»“åº“
    
    steps:
      - name: Checkout æºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source
      
      - name: Checkout ç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.REPO_SYNC_TOKEN }}
          path: target
      
      - name: åŒæ­¥æ–‡ä»¶
        run: |
          # å¤åˆ¶æŒ‡å®šçš„æ–‡ä»¶å’Œç›®å½•åˆ°ç›®æ ‡ä»“åº“
          # æ ¹æ®éœ€è¦ä¿®æ”¹è¿™äº›è·¯å¾„
          
          # åŒæ­¥ workflows ç›®å½•
          if [ -d "source/.github/workflows" ]; then
            mkdir -p target/.github/workflows
            cp -r source/.github/workflows/* target/.github/workflows/ || true
            # åˆ é™¤åŒæ­¥å·¥ä½œæµæœ¬èº«,é¿å…å¾ªç¯
            rm -f target/.github/workflows/alternative-sync.yml
          fi
          
          # åŒæ­¥ shared ç›®å½•
          if [ -d "source/shared" ]; then
            mkdir -p target/shared
            cp -r source/shared/* target/shared/ || true
          fi
          
          # åŒæ­¥æŒ‡å®šçš„æ–‡ä»¶
          [ -f "source/README.md" ] && cp source/README.md target/ || true
          [ -f "source/LICENSE" ] && cp source/LICENSE target/ || true
      
      - name: æ£€æŸ¥å˜æ›´
        id: check_changes
        working-directory: target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi
      
      - name: åˆ›å»º Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: target
        env:
          GH_TOKEN: ${{ secrets.REPO_SYNC_TOKEN }}
        run: |
          BRANCH_NAME="repo-sync/template-update-$(date +%s)"
          
          # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
          git checkout -b $BRANCH_NAME
          
          # æäº¤å˜æ›´
          git commit -m "chore: ä»æ¨¡æ¿ä»“åº“åŒæ­¥æ–‡ä»¶
          
          è‡ªåŠ¨ä» ${{ github.repository }} åŒæ­¥æ›´æ–°"
          
          # æ¨é€åˆ†æ”¯
          git push origin $BRANCH_NAME
          
          # åˆ›å»º Pull Request
          gh pr create \
            --title "ğŸ”„ ä»æ¨¡æ¿ä»“åº“åŒæ­¥æ–‡ä»¶" \
            --body "æ­¤ PR è‡ªåŠ¨åŒæ­¥äº†æ¨¡æ¿ä»“åº“çš„æœ€æ–°å˜æ›´ã€‚

          **åŒæ­¥çš„å†…å®¹:**
          - GitHub Actions workflows
          - Shared é…ç½®æ–‡ä»¶
          - README å’Œ LICENSE æ–‡ä»¶
          
          **æºä»“åº“:** ${{ github.repository }}
          **æºæäº¤:** ${{ github.sha }}
          
          è¯·æ£€æŸ¥å˜æ›´å†…å®¹ååˆå¹¶ã€‚" \
            --base main \
            --head $BRANCH_NAME
      
      - name: åŒæ­¥ç»“æœ
        if: always()
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… æˆåŠŸåŒæ­¥åˆ° ${{ matrix.repo }}"
          else
            echo "â„¹ï¸  ${{ matrix.repo }} æ— éœ€æ›´æ–°"
          fi