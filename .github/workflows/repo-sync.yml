name: Repo Files Sync

on:
  push:
    branches:
      - main
    paths:
      - 'LICENSE'
  workflow_dispatch:

jobs:
  sync-to-repos:
    name: 同步文件到指定仓库
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 在这里明确列出要同步的目标仓库
        repo:
          - 'Hub-yang/50projects-vue3'
          - 'Hub-yang/about-me'
          - 'Hub-yang/todo-scripts'
          - 'Hub-yang/create-todo-vue'
          - 'Hub-yang/about-me-vue3'
          - 'Hub-yang/about-me-react'
          - 'Hub-yang/health-admin-nuxt3'
          - 'Hub-yang/my-vue-dev-template'
          - 'Hub-yang/my-react-dev-template'
          - 'Hub-yang/50projects-react'
          - 'Hub-yang/equals-demo'
          - 'Hub-yang/frontend-forest'
          - 'Hub-yang/my-blog-new'
          - 'Hub-yang/todo-utils'
          - 'Hub-yang/music-preview'
          - 'Hub-yang/js-equals-demo'
      fail-fast: false
    
    steps:
      - name: Checkout 源仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source
      
      - name: Checkout 目标仓库
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.REPO_SYNC_TOKEN }}
          path: target
      
      - name: 同步文件
        run: |
          echo "开始同步文件到 ${{ matrix.repo }}"
          
          # 同步 workflows 目录
          # if [ -d "source/.github/workflows" ]; then
          #   echo "同步 .github/workflows 目录"
          #   mkdir -p target/.github/workflows
          #   cp -r source/.github/workflows/* target/.github/workflows/ || true
          #   # 删除同步工作流本身,避免循环同步
          #   rm -f target/.github/workflows/alternative-sync.yml
          # fi
          
          # # 同步 shared 目录
          # if [ -d "source/shared" ]; then
          #   echo "同步 shared 目录"
          #   mkdir -p target/shared
          #   cp -r source/shared/* target/shared/ || true
          # fi
          
          # 同步指定的文件
          # if [ -f "source/README.md" ]; then
          #   echo "同步 README.md"
          #   cp source/README.md target/
          # fi
          
          if [ -f "source/LICENSE" ]; then
            echo "同步 LICENSE"
            cp source/LICENSE target/
          fi
          
          echo "文件同步完成"
      
      - name: 提交并推送变更
        working-directory: target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "没有检测到文件变更，跳过提交"
            echo "SYNC_STATUS=no_changes" >> $GITHUB_ENV
          else
            echo "检测到文件变更，准备提交"
            git commit -m "chore: synchronize files from init-template repo

          自动从 ${{ github.repository }} 同步更新
          源提交: ${{ github.sha }}
          触发事件: ${{ github.event_name }}"
            
            git push origin main
            
            echo "SYNC_STATUS=synced" >> $GITHUB_ENV
            echo "✅ 变更已成功推送到 ${{ matrix.repo }}"
          fi
      
      - name: 同步结果摘要
        if: always()
        run: |
          if [ "${{ env.SYNC_STATUS }}" == "synced" ]; then
            echo "::notice::成功同步文件到 ${{ matrix.repo }}"
          elif [ "${{ env.SYNC_STATUS }}" == "no_changes" ]; then
            echo "::notice::${{ matrix.repo }} 无需更新，文件已是最新"
          else
            echo "::warning::${{ matrix.repo }} 同步状态未知"
          fi